<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentient Meme Maker | Professional Edition</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;500;700&family=Impact&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <style>
        :root {
            --primary-color: #0d6efd; --dark-grey: #212529; --mid-grey: #495057;
            --light-grey: #f8f9fa; --border-color: #dee2e6; --background: #f1f3f5;
            --white: #ffffff; --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --font-ui: 'Inter', sans-serif; --font-meme: 'Impact', sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-ui); background-color: var(--background);
            color: var(--dark-grey); line-height: 1.6;
        }
        .container { max-width: 960px; margin: 0 auto; padding: 0 20px; }
        .site-header {
            background: var(--white); padding: 1rem 0;
            border-bottom: 1px solid var(--border-color); margin-bottom: 2rem;
        }
        .site-header .container { display: flex; align-items: center; }
        .site-header .logo { height: 40px; margin-right: 1rem; }
        .site-header h1 { font-size: 1.5rem; font-weight: 700; }
        #template-feed { display: flex; flex-direction: column; gap: 2rem; }
        .template-post {
            background: var(--white); border-radius: 8px;
            box-shadow: var(--shadow); overflow: hidden;
        }
        .post-header {
            padding: 1rem 1.5rem; font-weight: 500;
            border-bottom: 1px solid var(--border-color);
        }
        .post-image-container { background-color: var(--dark-grey); }
        .post-image {
            display: block; width: 100%; max-height: 70vh; object-fit: contain;
        }
        .post-actions { padding: 1rem 1.5rem; }
        .create-btn {
            width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 700;
            color: var(--white); background-color: var(--primary-color);
            border: none; border-radius: 6px; cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .create-btn:hover { background-color: #0b5ed7; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: flex; align-items: center;
            justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: var(--white); width: 95%; max-width: 1400px;
            height: 90vh; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; position: relative;
        }
        .close-btn {
            position: absolute; top: 10px; right: 20px; font-size: 2.5rem;
            color: var(--mid-grey); background: none; border: none; cursor: pointer;
        }

        /* --- DOWNLOAD BUTTON FIX STARTS HERE --- */
        .editor-layout {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 2rem 1rem;
            gap: 1rem;
            overflow: hidden; /* Important: prevents the whole layout from scrolling */
        }
        .canvas-container {
            flex-shrink: 0; /* Prevents canvas from shrinking on mobile */
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light-grey);
            border-radius: 8px;
            min-height: 250px; /* Adjusted min-height */
            flex-basis: 40%; /* Give it a base size */
        }
        .controls-container {
            flex-grow: 1; /* Takes up remaining vertical space */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Important: Prevents its own children from overflowing */
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }
        .scrollable-controls {
            flex-grow: 1; /* This makes this div take all available space inside controls-container */
            overflow-y: auto; /* Adds scrollbar ONLY to this area if content overflows */
            padding-right: 10px; /* space for scrollbar */
        }
        .button-group {
            flex-shrink: 0; /* Ensures this part never shrinks */
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        @media (min-width: 1024px) {
            .editor-layout { flex-direction: row; padding: 2rem; gap: 2rem; }
            .canvas-container { flex-basis: auto; flex-grow: 1; }
            .controls-container {
                width: 320px;
                flex-grow: 0; /* Reset grow */
                padding-top: 0;
                border-top: none;
                border-left: 1px solid var(--border-color);
                padding-left: 1rem;
            }
            .scrollable-controls { padding-right: 0; }
        }
        /* --- DOWNLOAD BUTTON FIX ENDS HERE --- */
        
        .controls-container h4 { margin-top: 0; margin-bottom: 0.75rem; }
        .controls-container hr {
            border: none; border-top: 1px solid var(--border-color); margin: 1.5rem 0;
        }
        .control-group { margin-bottom: 1rem; }
        .control-group label {
            display: block; font-size: 0.9rem;
            margin-bottom: 0.25rem; color: var(--mid-grey);
        }
        .control-group input, .control-group select {
            width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;
        }
        .text-align-group div { display: flex; gap: 5px; }
        .align-btn { width: 100%; font-weight: bold; }
        .layers-panel {
            background: var(--light-grey); border-radius: 6px; min-height: 100px;
            max-height: 200px; overflow-y: auto; padding: 0.5rem;
        }
        .layer-item {
            padding: 0.5rem 0.75rem; margin-bottom: 5px; border-radius: 4px;
            cursor: pointer; background: var(--white); border: 1px solid var(--border-color);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .layer-item.active {
            background: var(--primary-color); color: var(--white); border-color: var(--primary-color);
        }
        .button-group button {
            width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 500;
            border-radius: 6px; cursor: pointer; transition: background-color 0.2s ease;
            border: 1px solid transparent;
        }
        .button-group button:active { transform: scale(0.98); }
        #add-text-btn { background-color: var(--primary-color); color: var(--white); }
        #delete-btn { background-color: #dc3545; color: var(--white); }
        #download-btn { background-color: #198754; color: var(--white); }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <img src="https://i.postimg.cc/fySwfJcf/20250904-032927.png" alt="Logo" class="logo">
            <h1>Sentient Meme Maker</h1>
        </div>
    </header>

    <main class="container">
        <div id="template-feed"></div>
    </main>

    <div id="editor-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-modal-btn" class="close-btn">&times;</button>
            <div class="editor-layout">
                <div class="canvas-container">
                    <canvas id="meme-canvas"></canvas>
                </div>
                <div class="controls-container">
                    <div class="scrollable-controls">
                        <h4>Layers</h4>
                        <div id="layers-panel" class="layers-panel"></div>
                        <hr>
                        <h4>Text Controls</h4>
                        <div class="control-group">
                            <label>Font Family</label>
                            <select id="font-family">
                                <option>Impact</option><option>Anton</option><option>Arial</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Font Size</label>
                            <input type="range" id="font-size" min="10" max="120" value="40">
                        </div>
                        <div class="control-group">
                            <label>Fill Color</label>
                            <input type="color" id="text-color" value="#FFFFFF">
                        </div>
                        <div class="control-group">
                            <label>Outline Width</label>
                            <input type="range" id="stroke-width" min="0" max="10" value="2">
                        </div>
                        <div class="control-group">
                            <label>Outline Color</label>
                            <input type="color" id="stroke-color" value="#000000">
                        </div>
                        <div class="control-group text-align-group">
                             <label>Align</label>
                             <div>
                                <button class="align-btn" data-align="left">L</button>
                                <button class="align-btn" data-align="center">C</button>
                                <button class="align-btn" data-align="right">R</button>
                             </div>
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="add-text-btn">Add Text</button>
                        <button id="delete-btn">Delete Layer</button>
                        <button id="download-btn">Download Meme</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const templates = [
            { id: "t1", name: "Template 1 (Happiness turned into Sadness)", image: "https://i.postimg.cc/3wJ8rrkZ/Final-1.jpg", textBoxes: 2 },
            { id: "t2", name: "Template 2 (which was is real dobby)", image: "https://i.postimg.cc/3NsLnntC/Final-2.jpg", textBoxes: 3 },
            { id: "t3", name: "Template 3 (Burning house Dobby)", image: "https://i.postimg.cc/sXqdCPn1/Final-3.jpg", textBoxes: 2 },
            { id: "t4", name: "Template 4 (Success dobby)", image: "https://i.postimg.cc/TYjStXXK/Final-4.jpg", textBoxes: 2 },
            { id: "t5", name: "Template 5 (Dobby saying think about it)", image: "https://i.postimg.cc/gkQ02LSv/Final-5.jpg", textBoxes: 2 },
            { id: "t6", name: "Template 6 (Distracted Dobby)", image: "https://i.postimg.cc/xdyj5x0R/Final-6.jpg", textBoxes: 3 },
            { id: "t7", name: "Template 7 (Confused Dobby)", image: "https://i.postimg.cc/5t1bXBwF/Final-7.jpg", textBoxes: 2 },
            { id: "t8", name: "Template 8 (Flex tape)", image: "https://i.postimg.cc/zXgrpt7g/Final-8.jpg", textBoxes: 3 },
            { id: "t9", name: "Template 9 (No yes)", image: "https://i.postimg.cc/WbsybFSH/Final-9.jpg", textBoxes: 2 },
            { id: "t10", name: "Template 10 (probably he is thinking about other woman)", image: "https://i.postimg.cc/7ZWtVB4F/Final-10.jpg", textBoxes: 2 },
            { id: "t11", name: "Template 11 (Left exit 12 off Ramp)", image: "https://i.postimg.cc/tTH5SwMM/Final-11.png", textBoxes: 2 },
            { id: "t12", name: "Template 12 (Confused Dobby)", image: "https://i.postimg.cc/44PkqDZn/Final-12.png", textBoxes: 2 }
        ];

        const templateFeed = document.getElementById('template-feed');
        const editorModal = document.getElementById('editor-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const layersPanel = document.getElementById('layers-panel');
        let canvas;
        const FONT_FAMILY_INPUT = document.getElementById('font-family');
        const FONT_SIZE_INPUT = document.getElementById('font-size');
        const TEXT_COLOR_INPUT = document.getElementById('text-color');
        const STROKE_WIDTH_INPUT = document.getElementById('stroke-width');
        const STROKE_COLOR_INPUT = document.getElementById('stroke-color');

        function createTemplatePost(template, onEdit) {
            const post = document.createElement('div');
            post.className = 'template-post';
            post.innerHTML = `
                <div class="post-header"><h3>${template.name}</h3></div>
                <div class="post-image-container"><img src="${template.image}" alt="${template.name}" class="post-image" loading="lazy"></div>
                <div class="post-actions"><button class="create-btn">Create Meme</button></div>`;
            post.querySelector('.create-btn').addEventListener('click', () => onEdit(template));
            return post;
        }

        function initializeFeed(onEditCallback) {
            templates.forEach(template => {
                const postElement = createTemplatePost(template, onEditCallback);
                templateFeed.appendChild(postElement);
            });
        }

        const showEditor = () => { editorModal.style.display = 'flex'; };
        const hideEditor = () => { editorModal.style.display = 'none'; };
        
        function initializeModal() {
            closeModalBtn.addEventListener('click', hideEditor);
        }
function renderLayers(canvasObjects, activeObject, onLayerClick) {
            layersPanel.innerHTML = '';
            canvasObjects.forEach((obj, index) => {
                if (obj.type === 'textbox') {
                    const item = document.createElement('div');
                    item.className = 'layer-item';
                    item.textContent = obj.text ? (obj.text.substring(0, 20) + (obj.text.length > 20 ? '...' : '')) : `Text ${index + 1}`;
                    item.dataset.index = index;
                    if (obj === activeObject) { item.classList.add('active'); }
                    item.addEventListener('click', () => onLayerClick(obj));
                    layersPanel.appendChild(item);
                }
            });
        }
        
        function initializeCanvas() {
            canvas = new fabric.Canvas('meme-canvas', {
                backgroundColor: '#f0f0f0',
                preserveObjectStacking: true
            });
            canvas.on('selection:created', updateControls);
            canvas.on('selection:updated', updateControls);
            canvas.on('selection:cleared', updateControls);
            canvas.on('object:modified', updateLayers);
            canvas.on('object:added', updateLayers);
            canvas.on('object:removed', updateLayers);
            return canvas;
        }

        function loadTemplate(template) {
            canvas.remove(...canvas.getObjects());
            canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
            fabric.Image.fromURL(template.image, (img) => {
                const container = document.querySelector('.canvas-container');
                const containerWidth = container.offsetWidth;
                const containerHeight = container.offsetHeight;
                const scaleX = containerWidth / img.width;
                const scaleY = containerHeight / img.height;
                const scale = Math.min(scaleX, scaleY);
                const scaledWidth = img.width * scale;
                const scaledHeight = img.height * scale;
                
                canvas.setWidth(scaledWidth);
                canvas.setHeight(scaledHeight);
                
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                    scaleX: scale,
                    scaleY: scale,
                    left: 0, 
                    top: 0,
                    originX: 'left',
                    originY: 'top'
                });
                
                for (let i = 0; i < template.textBoxes; i++) { addTextObject(); }
                canvas.renderAll();
            }, { crossOrigin: 'anonymous' });
        }

        function addTextObject() {
            const text = new fabric.Textbox('ADD TEXT HERE', {
                left: canvas.width * 0.1,
                top: canvas.getHeight() * (0.1 + (canvas.getObjects().length * 0.1)),
                width: canvas.width * 0.8,
                fontSize: parseInt(FONT_SIZE_INPUT.value, 10),
                fontFamily: FONT_FAMILY_INPUT.value,
                fill: TEXT_COLOR_INPUT.value,
                stroke: STROKE_COLOR_INPUT.value,
                strokeWidth: parseInt(STROKE_WIDTH_INPUT.value, 10),
                textAlign: 'center',
                cornerColor: '#0d6efd',
                cornerSize: 12,
                transparentCorners: false,
                padding: 7
            });
            canvas.add(text);
            canvas.setActiveObject(text);
            canvas.renderAll();
        }

        function deleteActiveObject() {
            const activeObject = canvas.getActiveObject();
            if (activeObject) { canvas.remove(activeObject); canvas.renderAll(); }
        }

        function updateActiveObjectProperty(prop, value) {
            const activeObject = canvas.getActiveObject();
            if (activeObject) { 
                activeObject.set(prop, value); 
                canvas.renderAll(); 
                updateLayers();
            }
        }

        function updateControls() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'textbox') {
                FONT_FAMILY_INPUT.value = activeObject.fontFamily;
                FONT_SIZE_INPUT.value = activeObject.fontSize;
                TEXT_COLOR_INPUT.value = activeObject.fill;
                STROKE_WIDTH_INPUT.value = activeObject.strokeWidth;
                STROKE_COLOR_INPUT.value = activeObject.stroke;
            } else {
                FONT_FAMILY_INPUT.value = 'Impact';
                FONT_SIZE_INPUT.value = '40';
                TEXT_COLOR_INPUT.value = '#FFFFFF';
                STROKE_WIDTH_INPUT.value = '2';
                STROKE_COLOR_INPUT.value = '#000000';
            }
            updateLayers();
        }

        function updateLayers() {
            renderLayers(canvas.getObjects(), canvas.getActiveObject(), (obj) => {
                canvas.setActiveObject(obj);
                canvas.renderAll();
                updateControls();
            });
        }

        function setupControls() {
            document.getElementById('add-text-btn').addEventListener('click', addTextObject);
            document.getElementById('delete-btn').addEventListener('click', deleteActiveObject);
            FONT_FAMILY_INPUT.addEventListener('change', (e) => updateActiveObjectProperty('fontFamily', e.target.value));
            FONT_SIZE_INPUT.addEventListener('input', (e) => updateActiveObjectProperty('fontSize', parseInt(e.target.value, 10)));
            TEXT_COLOR_INPUT.addEventListener('input', (e) => updateActiveObjectProperty('fill', e.target.value));
            STROKE_WIDTH_INPUT.addEventListener('input', (e) => updateActiveObjectProperty('strokeWidth', parseInt(e.target.value, 10)));
            STROKE_COLOR_INPUT.addEventListener('input', (e) => updateActiveObjectProperty('stroke', e.target.value));
            document.querySelectorAll('.align-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    updateActiveObjectProperty('textAlign', e.target.dataset.align);
                });
            });
            document.getElementById('download-btn').addEventListener('click', () => {
                const dataURL = canvas.toDataURL({ format: 'png', quality: 1.0, multiplier: 2 });
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = 'sentient-meme.png';
                link.click();
            });
        }
        
        function main() {
            initializeModal();
            initializeCanvas();
            setupControls();
            
            const handleEditClick = (template) => {
                showEditor();
                setTimeout(() => { 
                    loadTemplate(template); 
                }, 100); 
            };
            initializeFeed(handleEditClick);
            
            console.log("Sentient Meme Maker Professional Edition Initialized.");
        }
        
        main();
    });
    </script>
</body>
</html>